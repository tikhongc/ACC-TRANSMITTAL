import{l as h,e as B,w as H,m as te,r as $,c,o as n,u as f,f as P,s as k,a as u,F as N,j as F,A as z,t as p,k as O,h as K,M as D}from"./index-Bf276Rcj.js";function ut(o){return o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}):""}const S="http://localhost:8080",ve="b.1eea4119-3553-4167-b93d-3a3d5d07d33d";async function U(o,l={}){const r=await fetch(o,{headers:{"Content-Type":"application/json",...l.headers},...l}),m=await r.json();if(!r.ok)throw new Error(m.error||`HTTP error! status: ${r.status}`);return m}async function ae(o={}){const l=new URLSearchParams({page:o.page||1,page_size:o.page_size||100,...o}),r=`${S}/api/accounts/users?${l}`;return await U(r)}async function pe(o={}){const l=new URLSearchParams({page:o.page||1,page_size:o.page_size||100,...o}),r=`${S}/api/accounts/roles?${l}`;return await U(r)}async function fe(o={}){const l=new URLSearchParams({page:o.page||1,page_size:o.page_size||100,...o}),r=`${S}/api/accounts/companies?${l}`;return await U(r)}const ye=(o,l)=>{const r=o.__vccOpts||o;for(const[m,C]of l)r[m]=C;return r},he={class:"recipient-selector"},ge={class:"tab-content"},xe={key:0,class:"flex justify-center py-4"},we={key:1,class:"max-h-[300px] overflow-y-auto"},ke={key:0,class:"text-center text-gray-500 py-4"},Ce=["onClick"],Se={class:"ml-3 flex-1"},be={class:"text-sm font-medium text-gray-900"},$e={class:"text-xs text-gray-500"},Ue={key:0,class:"text-xs text-gray-400"},Ve={class:"tab-content"},Re={key:0,class:"flex justify-center py-4"},Te={key:1,class:"max-h-[300px] overflow-y-auto"},Ie={key:0,class:"text-center text-gray-500 py-4"},Pe={class:"ml-3 flex-1"},ze={class:"text-sm font-medium text-gray-900"},Ne={class:"text-xs text-gray-500"},Fe={key:0,class:"ml-2"},Le={class:"pl-8"},Oe=["onClick"],je={class:"ml-3 flex-1"},qe={class:"text-sm font-medium text-gray-900"},Ae={class:"text-xs text-gray-500"},Be={key:0,class:"text-center text-gray-400 py-2 text-xs"},De={class:"tab-content"},Je={key:0,class:"flex justify-center py-4"},Me={key:1,class:"max-h-[300px] overflow-y-auto"},Ee={key:0,class:"text-center text-gray-500 py-4"},Qe={class:"ml-3 flex-1"},Xe={class:"text-sm font-medium text-gray-900"},He={class:"text-xs text-gray-500"},Ke={class:"pl-8"},Ze=["onClick"],Ge={class:"ml-3 flex-1"},We={class:"text-sm font-medium text-gray-900"},Ye={class:"text-xs text-gray-500"},et={key:0,class:"text-center text-gray-400 py-2 text-xs"},tt={key:0,class:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg"},at={class:"flex items-center justify-between mb-2"},st={class:"text-sm font-medium text-blue-900"},ot={class:"flex flex-wrap gap-2"},nt={key:0,class:"text-xs text-blue-600"},lt={__name:"RecipientSelector",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(o,{emit:l}){const r=l,m=h("users"),C=h(""),g=h(""),v=h(""),x=h([]),V=h([]),R=h([]),d=h(!1),b=h(!1),j=h(!1),w=h(new Set),y=h(new Set),T=h(new Set);async function se(){try{d.value=!0;const e=await ae({page_size:100});e.status==="success"&&e.data&&(x.value=e.data.users||[])}catch(e){D.error("Failed to load users: "+e.message),console.error("Failed to load users:",e)}finally{d.value=!1}}async function oe(){try{b.value=!0;const e=await fe({page_size:100});e.status==="success"&&e.data&&(V.value=e.data.companies||[])}catch(e){D.error("Failed to load companies: "+e.message),console.error("Failed to load companies:",e)}finally{b.value=!1}}async function ne(){try{j.value=!0;const e=await pe({page_size:100});e.status==="success"&&e.data&&(R.value=e.data.roles||[],console.log("[RecipientSelector] Loaded roles:",R.value.length),R.value.forEach(t=>{var a;console.log(`Role: ${t.name}, Users count: ${((a=t.users)==null?void 0:a.length)||0}`)}))}catch(e){D.error("Failed to load roles: "+e.message),console.error("Failed to load roles:",e)}finally{j.value=!1}}const Z=B(()=>{if(!C.value.trim())return x.value;const e=C.value.toLowerCase();return x.value.filter(t=>{var a,i;return((a=t.name)==null?void 0:a.toLowerCase().includes(e))||((i=t.email)==null?void 0:i.toLowerCase().includes(e))})}),G=B(()=>{if(!g.value.trim())return V.value;const e=g.value.toLowerCase();return V.value.filter(t=>{var a;return(a=t.name)==null?void 0:a.toLowerCase().includes(e)})}),W=B(()=>{if(!v.value.trim())return R.value;const e=v.value.toLowerCase();return R.value.filter(t=>{var a;return(a=t.name)==null?void 0:a.toLowerCase().includes(e)})});function J(e){const t=V.value.find(a=>a.company_id===e);return t&&t.users?t.users:x.value.filter(a=>a.company_id===e)}function M(e){const t=R.value.find(a=>a.role_id===e);return t&&t.users?t.users:x.value.filter(a=>a.roles&&a.roles.some(i=>i.role_id===e||i.id===e))}function E(e){return w.value.has(e.user_id)}function le(e){return y.value.has(e.company_id)}function ie(e){return T.value.has(e.role_id)}function L(e){w.value.has(e.user_id)?w.value.delete(e.user_id):w.value.add(e.user_id),w.value=new Set(w.value),q()}function re(e){y.value.has(e.company_id)?y.value.delete(e.company_id):y.value.add(e.company_id),y.value=new Set(y.value),q()}function ue(e){T.value.has(e.role_id)?T.value.delete(e.role_id):T.value.add(e.role_id),T.value=new Set(T.value),q()}function ce(){w.value=new Set,y.value=new Set,T.value=new Set,q()}function de(e){w.value.delete(e.user_id),w.value=new Set(w.value),q()}const I=B(()=>{const e=new Map;for(const t of w.value){const a=x.value.find(i=>i.user_id===t);a&&a.email&&e.set(a.email,{user_id:a.user_id,name:a.name,email:a.email,company_name:a.company_name})}for(const t of y.value){const a=V.value.find(i=>i.company_id===t);if(a&&a.users)for(const i of a.users)i.email&&e.set(i.email,{user_id:i.user_id,name:i.name,email:i.email,company_name:a.name})}for(const t of T.value){const a=R.value.find(i=>i.role_id===t);if(a&&a.users)for(const i of a.users)i.email&&e.set(i.email,{user_id:i.user_id,name:i.name,email:i.email,company_name:i.company_name})}return Array.from(e.values())});function q(){r("update:modelValue",I.value)}return H(I,()=>{r("update:modelValue",I.value)}),te(()=>{se(),oe(),ne()}),(e,t)=>{const a=$("a-input-search"),i=$("a-spin"),A=$("a-checkbox"),Q=$("a-tab-pane"),Y=$("a-collapse-item"),ee=$("a-collapse"),me=$("a-tabs"),_e=$("a-tag");return n(),c("div",he,[f(me,{"active-key":m.value,"onUpdate:activeKey":t[10]||(t[10]=s=>m.value=s),type:"line"},{default:k(()=>[f(Q,{key:"users",title:"Users"},{default:k(()=>[u("div",ge,[f(a,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=s=>C.value=s),placeholder:"Search users...",class:"mb-3"},null,8,["modelValue"]),d.value?(n(),c("div",xe,[f(i)])):(n(),c("div",we,[Z.value.length===0?(n(),c("div",ke," No users found ")):P("",!0),(n(!0),c(N,null,F(Z.value,s=>(n(),c("div",{key:s.user_id,class:"flex items-center py-2 px-2 hover:bg-gray-50 rounded cursor-pointer",onClick:_=>L(s)},[f(A,{"model-value":E(s),onClick:t[1]||(t[1]=z(()=>{},["stop"])),onChange:_=>L(s)},null,8,["model-value","onChange"]),u("div",Se,[u("div",be,p(s.name),1),u("div",$e,p(s.email),1)]),s.company_name?(n(),c("div",Ue,p(s.company_name),1)):P("",!0)],8,Ce))),128))]))])]),_:1}),f(Q,{key:"companies",title:"Companies"},{default:k(()=>[u("div",Ve,[f(a,{modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=s=>g.value=s),placeholder:"Search companies...",class:"mb-3"},null,8,["modelValue"]),b.value?(n(),c("div",Re,[f(i)])):(n(),c("div",Te,[G.value.length===0?(n(),c("div",Ie," No companies found ")):(n(),O(ee,{key:1,bordered:!1,"expand-icon-position":"right"},{default:k(()=>[(n(!0),c(N,null,F(G.value,s=>(n(),O(Y,{key:s.company_id,header:s.name},{header:k(()=>[u("div",{class:"flex items-center w-full",onClick:t[4]||(t[4]=z(()=>{},["stop"]))},[f(A,{"model-value":le(s),onChange:_=>re(s),onClick:t[3]||(t[3]=z(()=>{},["stop"]))},null,8,["model-value","onChange"]),u("div",Pe,[u("div",ze,p(s.name),1),u("div",Ne,[K(p(J(s.company_id).length)+" users ",1),s.trade?(n(),c("span",Fe,"| "+p(s.trade),1)):P("",!0)])])])]),default:k(()=>[u("div",Le,[(n(!0),c(N,null,F(J(s.company_id),_=>(n(),c("div",{key:_.user_id,class:"flex items-center py-2 px-2 hover:bg-gray-50 rounded cursor-pointer",onClick:X=>L(_)},[f(A,{"model-value":E(_),onClick:t[5]||(t[5]=z(()=>{},["stop"])),onChange:X=>L(_)},null,8,["model-value","onChange"]),u("div",je,[u("div",qe,p(_.name),1),u("div",Ae,p(_.email),1)])],8,Oe))),128)),J(s.company_id).length===0?(n(),c("div",Be," No users in this company ")):P("",!0)])]),_:2},1032,["header"]))),128))]),_:1}))]))])]),_:1}),f(Q,{key:"roles",title:"Roles"},{default:k(()=>[u("div",De,[f(a,{modelValue:v.value,"onUpdate:modelValue":t[6]||(t[6]=s=>v.value=s),placeholder:"Search roles...",class:"mb-3"},null,8,["modelValue"]),j.value?(n(),c("div",Je,[f(i)])):(n(),c("div",Me,[W.value.length===0?(n(),c("div",Ee," No roles found ")):(n(),O(ee,{key:1,bordered:!1,"expand-icon-position":"right"},{default:k(()=>[(n(!0),c(N,null,F(W.value,s=>(n(),O(Y,{key:s.role_id,header:s.name},{header:k(()=>[u("div",{class:"flex items-center w-full",onClick:t[8]||(t[8]=z(()=>{},["stop"]))},[f(A,{"model-value":ie(s),onChange:_=>ue(s),onClick:t[7]||(t[7]=z(()=>{},["stop"]))},null,8,["model-value","onChange"]),u("div",Qe,[u("div",Xe,p(s.name),1),u("div",He,p(M(s.role_id).length)+" users ",1)])])]),default:k(()=>[u("div",Ke,[(n(!0),c(N,null,F(M(s.role_id),_=>(n(),c("div",{key:_.user_id,class:"flex items-center py-2 px-2 hover:bg-gray-50 rounded cursor-pointer",onClick:X=>L(_)},[f(A,{"model-value":E(_),onClick:t[9]||(t[9]=z(()=>{},["stop"])),onChange:X=>L(_)},null,8,["model-value","onChange"]),u("div",Ge,[u("div",We,p(_.name),1),u("div",Ye,p(_.email),1)])],8,Ze))),128)),M(s.role_id).length===0?(n(),c("div",et," No users in this role ")):P("",!0)])]),_:2},1032,["header"]))),128))]),_:1}))]))])]),_:1})]),_:1},8,["active-key"]),I.value.length>0?(n(),c("div",tt,[u("div",at,[u("span",st," Selected "+p(I.value.length)+" recipient(s) ",1),u("button",{onClick:ce,class:"text-xs text-blue-600 hover:text-blue-800"}," Clear All ")]),u("div",ot,[(n(!0),c(N,null,F(I.value.slice(0,10),s=>(n(),O(_e,{key:s.user_id,closable:"",onClose:_=>de(s),size:"small"},{default:k(()=>[K(p(s.name||s.email),1)]),_:2},1032,["onClose"]))),128)),I.value.length>10?(n(),c("span",nt," +"+p(I.value.length-10)+" more ",1)):P("",!0)])])):P("",!0)])}}},ct=ye(lt,[["__scopeId","data-v-ef58dfea"]]);async function dt(o={}){const l=new URLSearchParams({limit:o.limit||100,offset:o.offset||0,...o}),r=`${S}/api/transmittals/${ve}/list?${l}`;return await U(r)}async function mt(o){const l=`${S}/api/transmittals/${o}/documents`;return await U(l)}async function _t(o){const l=`${S}/api/transmittals/${o}/recipients`;return await U(l)}async function vt(o,l){const r=`${S}/api/transmittals/${o}/mark-viewed`;return await U(r,{method:"POST",body:JSON.stringify({email:l})})}async function pt(o,l=null){const r=`${S}/api/transmittals/${o}/download-zip`,m=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l?{email:l}:{})});if(!m.ok){const V=await m.json();throw new Error(V.error||"Download failed")}const C=m.headers.get("X-File-Count"),g=m.headers.get("X-Total-Size"),v=m.headers.get("X-Failed-Files"),x=await m.blob();return x.metadata={fileCount:C?parseInt(C):0,totalSize:g?parseInt(g):0,failedFiles:v?JSON.parse(v):[]},x}async function ft(o){const l=`${S}/api/transmittals/create`;return await U(l,{method:"POST",body:JSON.stringify(o)})}async function yt(o,l){const r=`${S}/api/transmittals/${o}/documents`;return await U(r,{method:"POST",body:JSON.stringify(l)})}async function ht(o,l){const r=`${S}/api/transmittals/${o}/recipients`;return await U(r,{method:"POST",body:JSON.stringify(l)})}const it={class:"flex items-center gap-2"},gt={__name:"UserSelector",props:{modelValue:{type:String,default:""}},emits:["update:modelValue","user-changed"],setup(o,{expose:l,emit:r}){const m=r,C=o,g=h([]),v=h(C.modelValue),x=B(()=>{if(!v.value||!g.value.length)return{userId:"",autodeskId:"",name:"",email:""};const d=g.value.find(b=>b.autodesk_id===v.value);return d?{userId:d.user_id,autodeskId:d.autodesk_id,name:d.name,email:d.email}:{userId:"",autodeskId:"",name:"",email:""}});H(()=>C.modelValue,d=>{v.value=d}),H(v,d=>{m("update:modelValue",d),m("user-changed",x.value)});function V(){m("update:modelValue",v.value),m("user-changed",x.value)}async function R(){try{const d=await ae({page_size:100});(d.success||d.status==="success")&&d.data&&(g.value=d.data.users||[],g.value.length>0&&!v.value&&(v.value=g.value[0].autodesk_id))}catch(d){console.error("Failed to load available users:",d),D.error("Failed to load available users")}}return te(()=>{R()}),l({currentUser:x}),(d,b)=>{const j=$("a-option"),w=$("a-select");return n(),c("div",it,[b[1]||(b[1]=u("label",{class:"text-sm font-medium text-gray-700"},"Current User:",-1)),f(w,{modelValue:v.value,"onUpdate:modelValue":b[0]||(b[0]=y=>v.value=y),placeholder:"Select User...",style:{"min-width":"250px"},"allow-clear":"",onChange:V},{default:k(()=>[(n(!0),c(N,null,F(g.value,y=>(n(),O(j,{key:y.autodesk_id,value:y.autodesk_id},{default:k(()=>[K(p(y.name)+" ("+p(y.email)+") ",1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])])}}};export{S as A,ve as P,ct as R,ye as _,U as a,yt as b,ft as c,ht as d,gt as e,ut as f,dt as g,_t as h,fe as i,pe as j,pt as k,mt as l,vt as m};
